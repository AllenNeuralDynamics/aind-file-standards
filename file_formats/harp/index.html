<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation for the Allen Institute for Neural Dynamics File Standards"><meta name=author content="Allen Institute for Neural Dynamics and Contributors"><link href=../fip/ rel=prev><link href=../nwb/ rel=next><link rel=icon href=../../icon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.16"><title>Harp - AIND File Standards</title><link rel=stylesheet href=../../assets/stylesheets/main.7e37652d.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=black> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#standards-on-harp-device-data-acquisition class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="AIND File Standards" class="md-header__button md-logo" aria-label="AIND File Standards" data-md-component=logo> <img src=../../logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> AIND File Standards </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Harp </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=black aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=white aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/AllenNeuralDynamics/aind-file-standards title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> aind-file-standards </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Index </a> </li> <li class=md-tabs__item> <a href=../../core/contributing/ class=md-tabs__link> Core </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../behavior_videos/ class=md-tabs__link> File Formats </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="AIND File Standards" class="md-nav__button md-logo" aria-label="AIND File Standards" data-md-component=logo> <img src=../../logo.svg alt=logo> </a> AIND File Standards </label> <div class=md-nav__source> <a href=https://github.com/AllenNeuralDynamics/aind-file-standards title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> aind-file-standards </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Index </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Core </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Core </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../core/contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> <li class=md-nav__item> <a href=../../core/core-standards/ class=md-nav__link> <span class=md-ellipsis> Core Standards </span> </a> </li> <li class=md-nav__item> <a href=../../core/template/ class=md-nav__link> <span class=md-ellipsis> Template </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> File Formats </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> File Formats </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../behavior_videos/ class=md-nav__link> <span class=md-ellipsis> Behavior Videos </span> </a> </li> <li class=md-nav__item> <a href=../ecephys/ class=md-nav__link> <span class=md-ellipsis> Ecephys </span> </a> </li> <li class=md-nav__item> <a href=../fip/ class=md-nav__link> <span class=md-ellipsis> Fip </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Harp </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Harp </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Page contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Page contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#version class=md-nav__link> <span class=md-ellipsis> Version </span> </a> </li> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#acquisitionrawprimary-data-format class=md-nav__link> <span class=md-ellipsis> Acquisition/Raw/Primary Data Format </span> </a> <nav class=md-nav aria-label="Acquisition/Raw/Primary Data Format"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#on-the-deviceyml-file class=md-nav__link> <span class=md-ellipsis> On the device.yml file </span> </a> </li> <li class=md-nav__item> <a href=#optional-logging-of-commands class=md-nav__link> <span class=md-ellipsis> Optional logging of commands </span> </a> </li> <li class=md-nav__item> <a href=#application-notes class=md-nav__link> <span class=md-ellipsis> Application notes </span> </a> <nav class=md-nav aria-label="Application notes"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#clock-synchronization class=md-nav__link> <span class=md-ellipsis> Clock Synchronization </span> </a> </li> <li class=md-nav__item> <a href=#interfacing-with-bonsai class=md-nav__link> <span class=md-ellipsis> Interfacing with Bonsai </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#relationship-to-aind-data-schema class=md-nav__link> <span class=md-ellipsis> Relationship to aind-data-schema </span> </a> </li> <li class=md-nav__item> <a href=#file-quality-assurances class=md-nav__link> <span class=md-ellipsis> File Quality Assurances </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../nwb/ class=md-nav__link> <span class=md-ellipsis> Nwb </span> </a> </li> <li class=md-nav__item> <a href=../planar_ophys/ class=md-nav__link> <span class=md-ellipsis> Planar Ophys </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Page contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Page contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#version class=md-nav__link> <span class=md-ellipsis> Version </span> </a> </li> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#acquisitionrawprimary-data-format class=md-nav__link> <span class=md-ellipsis> Acquisition/Raw/Primary Data Format </span> </a> <nav class=md-nav aria-label="Acquisition/Raw/Primary Data Format"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#on-the-deviceyml-file class=md-nav__link> <span class=md-ellipsis> On the device.yml file </span> </a> </li> <li class=md-nav__item> <a href=#optional-logging-of-commands class=md-nav__link> <span class=md-ellipsis> Optional logging of commands </span> </a> </li> <li class=md-nav__item> <a href=#application-notes class=md-nav__link> <span class=md-ellipsis> Application notes </span> </a> <nav class=md-nav aria-label="Application notes"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#clock-synchronization class=md-nav__link> <span class=md-ellipsis> Clock Synchronization </span> </a> </li> <li class=md-nav__item> <a href=#interfacing-with-bonsai class=md-nav__link> <span class=md-ellipsis> Interfacing with Bonsai </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#relationship-to-aind-data-schema class=md-nav__link> <span class=md-ellipsis> Relationship to aind-data-schema </span> </a> </li> <li class=md-nav__item> <a href=#file-quality-assurances class=md-nav__link> <span class=md-ellipsis> File Quality Assurances </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=standards-on-harp-device-data-acquisition>Standards on harp device data acquisition<a class=headerlink href=#standards-on-harp-device-data-acquisition title="Permanent link">&para;</a></h1> <h2 id=version>Version<a class=headerlink href=#version title="Permanent link">&para;</a></h2> <p>0.2.0</p> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <p>While Harp data is largely used for behavior experiments, it is not limited to this modality. As a result, the current standard is scoped to the logging at the level of single Harp devices. The reason for this decision will hopefully become clear as we describe the format and some of the rationale behind it.</p> <p>Most of the Harp-related concepts mentioned here will be expanded in the <a href=https://harp-tech.org/protocol/BinaryProtocol-8bit.html>documentation of the protocol</a>.</p> <p>We will strictly follow the logging standards defined by <a href=https://harp-tech.org/articles/python.html#data-model>Harp</a>. This decision is justified by the following reasons:</p> <ul> <li>Affords the ability to not only use the same data format within our organization but also to share data with other groups that use Harp;</li> <li>Affords the ability to reuse common <a href=https://pypi.org/project/harp-python/0.2.0/ >data ingesting tools maintained by others</a>. Since it is an open-source community standard, we also have the ability to contribute to the development of these tools if we so wish;</li> <li>Affords re-usability of data acquisition, QC and processing pipelines that can be centralized and validated by us and potentially used by others.</li> </ul> <h2 id=acquisitionrawprimary-data-format>Acquisition/Raw/Primary Data Format<a class=headerlink href=#acquisitionrawprimary-data-format title="Permanent link">&para;</a></h2> <p>One of the main advantages of using a standardized binary communication protocol is that logging data from harp devices can be largely generalized. In theory, we could simply dump the binary data from the device into a single file and call it a day. However this is not always the most convenient way to log data. For instance, if one is interested in ingesting only a subset of messages (e.g. only the messages from a particular sensor or pin), then the previous approach would require a post-processing step to filter out the messages of interest. Furthermore, each address, as per harp protocol spec, has potentially different data formats (e.g. <code>U8</code> vs <code>U16</code>) or even different lengths if array registers are involved. This can make it very tedious to parse and analyze a binary file offline, since we will have to examine the header of each and every message in the file to determine how to extract its contents.</p> <p>This analysis could be entirely eliminated if we knew that all messages in the binary file had the same format. For any Harp device, the payload stored in a specific register will have a fixed type and length. This means that to ensure our simplifying assumption it is enough to save each message from a specific register into a different file (aka de-multiplexing strategy).</p> <p>Thus, for each device, the container of all data will be a single directory with the extension <code>&lt;&gt;.harp</code>. This directory will contain the following files:</p> <div class=highlight><pre><span></span><code>ðŸ“¦&lt;Device&gt;.harp
 â”£ ðŸ“œ&lt;DeviceName&gt;_0.bin
 â”£ ðŸ“œ&lt;DeviceName&gt;_1.bin
 â”£ ...
 â”£ ðŸ“œ&lt;DeviceName&gt;_&lt;Reg&gt;.bin
 â”— ðŸ“œdevice.yml
</code></pre></div> <p>where:</p> <ul> <li><code>&lt;DeviceName&gt;</code> will be derived from the <code>device.yml</code> metadata file that fully defines the device and can be found in the repository of each device (<a href=https://raw.githubusercontent.com/harp-tech/device.behavior/main/device.yml>e.g.</a>). This file can be seen as the "ground truth" specification of the device. It is used to automatically generate documentation, interfaces and data ingestion tools.</li> <li><code>&lt;Device&gt;</code> should match the name of the device in the <code>rig.json</code> schema file;</li> <li><code>&lt;Reg&gt;</code> is the register number that is logged in the binary file.</li> </ul> <h4 id=on-the-deviceyml-file>On the <code>device.yml</code> file<a class=headerlink href=#on-the-deviceyml-file title="Permanent link">&para;</a></h4> <p>Including the <code>device.yml</code> file that corresponds to the device interface used to log the device's data is required. This file affords the use of diverse tooling offered by the ecosystem, in particular <a href=https://github.com/harp-tech/harp-python>device-type-aware data ingestion tools</a>. Note that while the <code>device.yml</code> file specifies the targeted hardware, firmware, and core versions, it does not guarantee that the device from which data was acquired is running those versions. This metadata should instead be queried directly from the corresponding device's registers(<a href=https://harp-tech.org/protocol/Device.html#table---list-of-available-common-registers>see protocol core registers</a>)</p> <ul> <li>An example of an yml file can be found here: <a href=https://raw.githubusercontent.com/harp-tech/device.behavior/main/device.yml>device.yml</a></li> <li>And the schema for the yml file can be found here: <a href=https://raw.githubusercontent.com/harp-tech/protocol/refs/heads/main/schema/device.json>device.yml schema</a></li> </ul> <h4 id=optional-logging-of-commands>Optional logging of commands<a class=headerlink href=#optional-logging-of-commands title="Permanent link">&para;</a></h4> <p>A critical aspect of using the Harp protocol is that for each <code>Write</code> message received by the device from the PC host, the client will echo back a Write message timestamped by the embedded device. This assumes that all messages issued by the host are received by the device and not lost in transmission. However, this is not guaranteed. In case of a lost message, the host will not receive the echo back and cannot confirm that the message was received by the device.</p> <p>To perform post-hoc quality control, we recommend also logging <code>Commands</code>. Since <code>Commands</code> are also HarpMessage types, they can be logged in the same format as data from devices. We also recommend appending a software timestamp to each <code>Command</code> message to facilitate pairing requests with responses post-hoc.</p> <h3 id=application-notes>Application notes<a class=headerlink href=#application-notes title="Permanent link">&para;</a></h3> <p>All harp devices, regardless of their specific application, are expected to be logged according to the following standards:</p> <h4 id=clock-synchronization>Clock Synchronization<a class=headerlink href=#clock-synchronization title="Permanent link">&para;</a></h4> <p>We will only consider two operational modes for devices used in the AIND: <code>Standalone</code> and <code>Synchronized</code></p> <ul> <li>In <code>Standalone</code> mode the Harp device is not subordinate to a distributed clock, and all messages are timestamped by the device's internal clock. This mode can be used if only a single Harp device is used during experiment acquisition.</li> <li>In <code>Synchronized</code> mode, the Harp device is subordinate to a distributed clock, and all messages are timestamped by the distributed clock. This mode should be used when multiple Harp devices are used during experiment acquisition. In each experiment, there shall be a single clock generator source (e.g. <a href=https://github.com/AllenNeuralDynamics/harp.device.white-rabbit>WhiteRabbit device</a>) to which all devices are connected. This source device is logged like any other Harp device.</li> </ul> <h4 id=interfacing-with-bonsai>Interfacing with Bonsai<a class=headerlink href=#interfacing-with-bonsai title="Permanent link">&para;</a></h4> <p>The following points will describe recommendations and recipes for logging data from harp devices using <a href=https://bonsai-rx.org/ >Bonsai programming language</a>. We will assume a basic <a href=https://bonsai-rx.org/docs/ >understanding of the Bonsai programming language</a>, and <a href=https://harp-tech.org/articles/intro.html>how to interface with Harp devices from it</a>.</p> <p>Instructions on how to log data from a Harp device using Bonsai can be found in the <a href=https://harp-tech.org/articles/logging.html#groupbyregister>Harp Bonsai interface docs</a>. A "syntactic sugar" operator for logging device data with a corresponding device.yml file is also available in via the <a href=https://allenneuraldynamics.github.io/Bonsai.AllenNeuralDynamics/articles/core-logging.html#with-metadata>AllenNeuralDynamics.HarpUtils</a> package.</p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>In your experiments, always validate that your logging routine has fully initialized before requesting a reading dump from the device. Failure to do so may result in missing data.</p> </div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>In the future we will update these recipes to also provide AIND specific examples.</p> </div> <p>It is critical that the messages logged from the device are sufficient to reconstruct its state history. For that to be true, we need to know the initial state of all registers. This can be asked via a special register in the protocol core: <a href=https://harp-tech.org/protocol/Device.html#r_operation_ctrl-u16--operation-mode-configuration><code>OperationControl</code></a>. This register has a single bit that, when set, will trigger the device to send a dump all the values of all its registers.</p> <ul> <li>To the previous <a href=https://harp-tech.org/articles/logging.html#groupbyregister>logging example</a>, in a different branch:</li> <li>Add a <code>Timer</code> operator with its <code>DueTime</code> property set to 2 seconds. This will mimic the delayed start of an experiment.</li> <li>Add a <code>CreateMessage(Bonsai.Harp)</code> operator after the <code>Timer</code></li> <li>Select <code>OperationControlPayload</code> under <code>Payload</code>. Depending on your use case, you might want to change some of the settings, but we recommend:</li> <li><code>DumpRegisters</code> set to <code>True</code> (Required for the dump)</li> <li><code>Heartbeat</code> set to <code>True</code> (Useful to know the device is still alive)</li> <li><code>MuteReplies</code> set to <code>False</code></li> <li><code>OperationLed</code> set to <code>True</code></li> <li><code>OperationMode</code> set to <code>Active</code></li> <li><code>VisualIndicator</code> set to <code>On</code></li> <li>Add a <code>Multicast</code> operator to send the message to the device</li> </ul> <details> <summary>Workflow (Copy+Paste me)</summary> <div class=highlight><pre><span></span><code><span class=cp>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class=nt>&lt;WorkflowBuilder</span><span class=w> </span><span class=na>Version=</span><span class=s>&quot;2.8.1&quot;</span>
<span class=w>                 </span><span class=na>xmlns:xsi=</span><span class=s>&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class=w>                 </span><span class=na>xmlns:rx=</span><span class=s>&quot;clr-namespace:Bonsai.Reactive;assembly=Bonsai.Core&quot;</span>
<span class=w>                 </span><span class=na>xmlns:harp=</span><span class=s>&quot;clr-namespace:Bonsai.Harp;assembly=Bonsai.Harp&quot;</span>
<span class=w>                 </span><span class=na>xmlns=</span><span class=s>&quot;https://bonsai-rx.org/2018/workflow&quot;</span><span class=nt>&gt;</span>
<span class=w>  </span><span class=nt>&lt;Workflow&gt;</span>
<span class=w>    </span><span class=nt>&lt;Nodes&gt;</span>
<span class=w>      </span><span class=nt>&lt;Expression</span><span class=w> </span><span class=na>xsi:type=</span><span class=s>&quot;Combinator&quot;</span><span class=nt>&gt;</span>
<span class=w>        </span><span class=nt>&lt;Combinator</span><span class=w> </span><span class=na>xsi:type=</span><span class=s>&quot;rx:Timer&quot;</span><span class=nt>&gt;</span>
<span class=w>          </span><span class=nt>&lt;rx:DueTime&gt;</span>PT2S<span class=nt>&lt;/rx:DueTime&gt;</span>
<span class=w>          </span><span class=nt>&lt;rx:Period&gt;</span>PT0S<span class=nt>&lt;/rx:Period&gt;</span>
<span class=w>        </span><span class=nt>&lt;/Combinator&gt;</span>
<span class=w>      </span><span class=nt>&lt;/Expression&gt;</span>
<span class=w>      </span><span class=nt>&lt;Expression</span><span class=w> </span><span class=na>xsi:type=</span><span class=s>&quot;harp:CreateMessage&quot;</span><span class=nt>&gt;</span>
<span class=w>        </span><span class=nt>&lt;harp:MessageType&gt;</span>Write<span class=nt>&lt;/harp:MessageType&gt;</span>
<span class=w>        </span><span class=nt>&lt;harp:Payload</span><span class=w> </span><span class=na>xsi:type=</span><span class=s>&quot;harp:CreateOperationControlPayload&quot;</span><span class=nt>&gt;</span>
<span class=w>          </span><span class=nt>&lt;harp:OperationMode&gt;</span>Active<span class=nt>&lt;/harp:OperationMode&gt;</span>
<span class=w>          </span><span class=nt>&lt;harp:DumpRegisters&gt;</span>false<span class=nt>&lt;/harp:DumpRegisters&gt;</span>
<span class=w>          </span><span class=nt>&lt;harp:MuteReplies&gt;</span>false<span class=nt>&lt;/harp:MuteReplies&gt;</span>
<span class=w>          </span><span class=nt>&lt;harp:VisualIndicators&gt;</span>Off<span class=nt>&lt;/harp:VisualIndicators&gt;</span>
<span class=w>          </span><span class=nt>&lt;harp:OperationLed&gt;</span>Off<span class=nt>&lt;/harp:OperationLed&gt;</span>
<span class=w>          </span><span class=nt>&lt;harp:Heartbeat&gt;</span>Disabled<span class=nt>&lt;/harp:Heartbeat&gt;</span>
<span class=w>        </span><span class=nt>&lt;/harp:Payload&gt;</span>
<span class=w>      </span><span class=nt>&lt;/Expression&gt;</span>
<span class=w>      </span><span class=nt>&lt;Expression</span><span class=w> </span><span class=na>xsi:type=</span><span class=s>&quot;MulticastSubject&quot;</span><span class=nt>&gt;</span>
<span class=w>        </span><span class=nt>&lt;Name&gt;</span>BehaviorCommands<span class=nt>&lt;/Name&gt;</span>
<span class=w>      </span><span class=nt>&lt;/Expression&gt;</span>
<span class=w>    </span><span class=nt>&lt;/Nodes&gt;</span>
<span class=w>    </span><span class=nt>&lt;Edges&gt;</span>
<span class=w>      </span><span class=nt>&lt;Edge</span><span class=w> </span><span class=na>From=</span><span class=s>&quot;0&quot;</span><span class=w> </span><span class=na>To=</span><span class=s>&quot;1&quot;</span><span class=w> </span><span class=na>Label=</span><span class=s>&quot;Source1&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
<span class=w>      </span><span class=nt>&lt;Edge</span><span class=w> </span><span class=na>From=</span><span class=s>&quot;1&quot;</span><span class=w> </span><span class=na>To=</span><span class=s>&quot;2&quot;</span><span class=w> </span><span class=na>Label=</span><span class=s>&quot;Source1&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
<span class=w>    </span><span class=nt>&lt;/Edges&gt;</span>
<span class=w>  </span><span class=nt>&lt;/Workflow&gt;</span>
<span class=nt>&lt;/WorkflowBuilder&gt;</span>
</code></pre></div> </details> <p>Finally, commands to the device can be logged in the exact same way as replies. However, in order to facilitate post-hoc quality control, we recommend appending a software timestamp to each <code>Command</code> message. This can be done by <a href=https://harp-tech.org/articles/message-manipulation.html#injecting-or-modifying-message-timestamps>"injecting" a timestamp into the message payload</a> before logging. We recommend using high frequency events from a single device as a <a href=https://harp-tech.org/articles/message-manipulation.html#timestamping-generic-data>source of "the latest timestamp" to be used in the <code>Command</code> message</a>. We should stress that these timestamps should not be used for analysis that require precise and accurate synchronization, as they are not synchronized with the distributed clock.</p> <h3 id=relationship-to-aind-data-schema>Relationship to aind-data-schema<a class=headerlink href=#relationship-to-aind-data-schema title="Permanent link">&para;</a></h3> <p>Most fields tracked in <code>rig.json</code> can be easily extracted from the device's read-dump. It is likely that helper methods will be provided in the future to automate this conversion. For now, refer to the <a href=https://github.com/harp-tech/protocol/blob/main/Device.md#table---list-of-available-common-registers>protocol's core registers</a> to extract the necessary information.</p> <h3 id=file-quality-assurances>File Quality Assurances<a class=headerlink href=#file-quality-assurances title="Permanent link">&para;</a></h3> <p>By virtue of implementing the Harp communication and synchronization protocol the following should be true:</p> <p>1) Each data set should, at most, have a device as a source of the synchronized clock. 2) All messages from the device to the computer host should be logged. Once a message is successfully parsed, no more processing and/or filtering of the data stream will be done prior to logging. 3) All data from a single device will include the initial state of all registers. This can be achieved by setting the <code>DumpRegisters</code> bit in the <code>OperationControl</code> register. Given that this is true, inside the container folder, one file per register of the device is expected to be found with a minimum of one message in each file. 4) If Commands are logged, for each message sent to the device, a corresponding message should exist in the logged data from the harp device. The type of the message in the Command will match the type of the reply from the device. 5) If multiple devices are used, all data is assumed to be synchronized at acquisition time.</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="February 10, 2026 15:57:33 UTC">February 10, 2026</span> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> 2025, Allen Institute for Neural Dynamics </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../..", "features": ["content.tabs.link", "announce.dismiss", "navigation.tabs", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.preview", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.top", "navigation.tracking", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.50899def.min.js></script> </body> </html>